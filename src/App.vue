<template>
  <div>
    <p>test</p>
    <v-date-picker
      ref="datepicker"
      v-model='selectedDate'
      is-range
      is-expanded
      color="orange"
      :columns="2"
      :rows="1"
      :popover="{
        visibility: 'visible',
      }"
      :locale="{
        masks: {
          weekdays: 'WWW'
        }
      }"
      :attributes="attributesDates"
      :disabled-dates="disabledDates"
    />
  </div>
</template>

<script>
/* eslint-disable */
import plugin from './lib'

export default {
  components: [
  ],
  data () {
    return {
      attributesDates: {},
      startDate: null,
      selectedDate: {
        start: null,
        end: null
      }
    }
  },
  computed: {

    disabledDates () {
      if (this.isDragging) {
        let availableDates = this.getAvailableDates()
        console.log(availableDates)
        return Object.keys(this.allDates).filter(e => !availableDates.includes(e))
      } else {
        return Object.keys(this.allDates).filter(e => this.allDates[e] !== true)
      }
    },
    allDates () {
      if (this.pricesAvailibility == null) return []
      let allDates = {}
      let stringDate
      for(let date = moment(this.calendarFirstDate).startOf('day') ; date.isSameOrBefore(moment(this.calendarLastDate)) ; date.add(1, 'day') ) {
        stringDate = date.format('YYYY-MM-DD')
        // Le jour est une date d'arrivée possible
        if (Object.keys(this.pricesAvailibility).includes(stringDate)) {
          allDates[stringDate] = true
        }
        else {
          // Est ce que la date est inclue dans un séjour ?
          const lastPreviousStartDate = this.getLastPreviousStartDate(stringDate)
          if (lastPreviousStartDate) {
            const diffDays = this.isInRangeStay(lastPreviousStartDate, stringDate)
            if (diffDays) {
              allDates[stringDate] = diffDays
            // Sinon ce n'est pas disponible
            } else {
              allDates[stringDate] = false
            }
          }
        }
      }
      // this.disabledDates = this.getDisabledDates()
      return allDates
    },
  },
  methods: {

    getPricesAvailibility() {
      this.pricesAvailibility= {"2020-12-14":{"2020-12-17":1076,"2020-12-18":1326,"2020-12-19":1525},"2020-12-15":{"2020-12-18":1076,"2020-12-19":1326},"2020-12-16":{"2020-12-19":1076},"2021-01-02":{"2021-01-05":1181,"2021-01-06":1458,"2021-01-07":1680,"2021-01-08":1844,"2021-01-09":1788,"2021-01-16":3363},"2021-01-03":{"2021-01-06":1181,"2021-01-07":1458,"2021-01-08":1680,"2021-01-09":1844,"2021-01-10":1765,"2021-01-17":3340},"2021-01-04":{"2021-01-07":1181,"2021-01-08":1458,"2021-01-09":1680,"2021-01-10":1816,"2021-01-11":1742,"2021-01-18":3317},"2021-01-05":{"2021-01-08":1181,"2021-01-09":1458,"2021-01-10":1649,"2021-01-11":1788,"2021-01-12":1718,"2021-01-19":3293},"2021-01-06":{"2021-01-09":1181,"2021-01-10":1425,"2021-01-11":1618,"2021-01-12":1760,"2021-01-13":1695,"2021-01-20":3270},"2021-01-07":{"2021-01-10":1146,"2021-01-11":1392,"2021-01-12":1587,"2021-01-13":1732,"2021-01-14":1671,"2021-01-21":3246},"2021-01-08":{"2021-01-11":1111,"2021-01-12":1359,"2021-01-13":1556,"2021-01-14":1704,"2021-01-15":1648,"2021-01-22":3223},"2021-01-09":{"2021-01-12":1076,"2021-01-13":1326,"2021-01-14":1525,"2021-01-15":1676,"2021-01-16":1625,"2021-01-23":3200},"2021-01-10":{"2021-01-13":1076,"2021-01-14":1326,"2021-01-15":1525,"2021-01-16":1676,"2021-01-17":1625,"2021-01-24":3223},"2021-01-11":{"2021-01-14":1076,"2021-01-15":1326,"2021-01-16":1525,"2021-01-17":1676,"2021-01-18":1625,"2021-01-25":3246},"2021-01-12":{"2021-01-15":1076,"2021-01-16":1326,"2021-01-17":1525,"2021-01-18":1676,"2021-01-19":1625,"2021-01-26":3270},"2021-01-13":{"2021-01-16":1076,"2021-01-17":1326,"2021-01-18":1525,"2021-01-19":1676,"2021-01-20":1625,"2021-01-27":3293},"2021-01-14":{"2021-01-17":1076,"2021-01-18":1326,"2021-01-19":1525,"2021-01-20":1676,"2021-01-21":1625,"2021-01-28":3317},"2021-01-15":{"2021-01-18":1076,"2021-01-19":1326,"2021-01-20":1525,"2021-01-21":1676,"2021-01-22":1625,"2021-01-29":3340},"2021-01-16":{"2021-01-19":1076,"2021-01-20":1326,"2021-01-21":1525,"2021-01-22":1676,"2021-01-23":1625,"2021-01-30":3363},"2021-01-17":{"2021-01-20":1076,"2021-01-21":1326,"2021-01-22":1525,"2021-01-23":1676,"2021-01-24":1648,"2021-01-31":3387},"2021-01-18":{"2021-01-21":1076,"2021-01-22":1326,"2021-01-23":1525,"2021-01-24":1704,"2021-01-25":1671,"2021-02-01":3410},"2021-01-19":{"2021-01-22":1076,"2021-01-23":1326,"2021-01-24":1556,"2021-01-25":1732,"2021-01-26":1695,"2021-02-02":3434},"2021-01-20":{"2021-01-23":1076,"2021-01-24":1359,"2021-01-25":1587,"2021-01-26":1760,"2021-01-27":1718,"2021-02-03":3457},"2021-01-21":{"2021-01-24":1111,"2021-01-25":1392,"2021-01-26":1618,"2021-01-27":1788,"2021-01-28":1742,"2021-02-04":3480},"2021-01-22":{"2021-01-25":1146,"2021-01-26":1425,"2021-01-27":1649,"2021-01-28":1816,"2021-01-29":1765,"2021-02-05":3504},"2021-01-23":{"2021-01-26":1181,"2021-01-27":1458,"2021-01-28":1680,"2021-01-29":1844,"2021-01-30":1788,"2021-02-06":3527},"2021-01-24":{"2021-01-27":1181,"2021-01-28":1458,"2021-01-29":1680,"2021-01-30":1844,"2021-01-31":1788},"2021-01-25":{"2021-01-28":1181,"2021-01-29":1458,"2021-01-30":1680,"2021-01-31":1844,"2021-02-01":1788},"2021-01-26":{"2021-01-29":1181,"2021-01-30":1458,"2021-01-31":1680,"2021-02-01":1844,"2021-02-02":1788},"2021-01-27":{"2021-01-30":1181,"2021-01-31":1458,"2021-02-01":1680,"2021-02-02":1844,"2021-02-03":1788},"2021-01-28":{"2021-01-31":1181,"2021-02-01":1458,"2021-02-02":1680,"2021-02-03":1844,"2021-02-04":1788},"2021-01-29":{"2021-02-01":1181,"2021-02-02":1458,"2021-02-03":1680,"2021-02-04":1844,"2021-02-05":1788},"2021-01-30":{"2021-02-02":1181,"2021-02-03":1458,"2021-02-04":1680,"2021-02-05":1844,"2021-02-06":1788,"2021-02-13":4292},"2021-01-31":{"2021-02-03":1181,"2021-02-04":1458,"2021-02-05":1680,"2021-02-06":1844},"2021-02-01":{"2021-02-04":1181,"2021-02-05":1458,"2021-02-06":1680},"2021-02-02":{"2021-02-05":1181,"2021-02-06":1458},"2021-02-03":{"2021-02-06":1181},"2021-03-13":{"2021-03-16":1181,"2021-03-17":1458,"2021-03-18":1680,"2021-03-19":1844,"2021-03-20":1788,"2021-03-27":3732},"2021-03-14":{"2021-03-17":1181,"2021-03-18":1458,"2021-03-19":1680,"2021-03-20":1844,"2021-03-21":1956},"2021-03-15":{"2021-03-18":1181,"2021-03-19":1458,"2021-03-20":1680,"2021-03-21":1816,"2021-03-22":1930},"2021-03-16":{"2021-03-19":1181,"2021-03-20":1458,"2021-03-21":1649,"2021-03-22":1788,"2021-03-23":1904},"2021-03-17":{"2021-03-20":1181,"2021-03-21":1425,"2021-03-22":1618,"2021-03-23":1760,"2021-03-24":1878},"2021-03-18":{"2021-03-21":1146,"2021-03-22":1392,"2021-03-23":1587,"2021-03-24":1732,"2021-03-25":1852},"2021-03-19":{"2021-03-22":1111,"2021-03-23":1359,"2021-03-24":1556,"2021-03-25":1704,"2021-03-26":1826},"2021-03-20":{"2021-03-23":1076,"2021-03-24":1326,"2021-03-25":1525,"2021-03-26":1676,"2021-03-27":1800},"2021-03-21":{"2021-03-24":1076,"2021-03-25":1326,"2021-03-26":1525,"2021-03-27":1676},"2021-03-22":{"2021-03-25":1076,"2021-03-26":1326,"2021-03-27":1525},"2021-03-23":{"2021-03-26":1076,"2021-03-27":1326},"2021-03-24":{"2021-03-27":1076},"2021-04-03":{"2021-04-06":1403,"2021-04-07":1734,"2021-04-08":1995,"2021-04-09":2198,"2021-04-10":2360,"2021-04-17":4292},"2021-04-04":{"2021-04-07":1403,"2021-04-08":1734,"2021-04-09":1995,"2021-04-10":2198,"2021-04-11":2306,"2021-04-18":4212},"2021-04-05":{"2021-04-08":1403,"2021-04-09":1734,"2021-04-10":1995,"2021-04-11":2139,"2021-04-12":2252,"2021-04-19":4132},"2021-04-06":{"2021-04-09":1403,"2021-04-10":1734,"2021-04-11":1932,"2021-04-12":2080,"2021-04-13":2198,"2021-04-20":4052},"2021-04-07":{"2021-04-10":1403,"2021-04-11":1665,"2021-04-12":1869,"2021-04-13":2021,"2021-04-14":2144,"2021-04-21":3972},"2021-04-08":{"2021-04-11":1329,"2021-04-12":1596,"2021-04-13":1806,"2021-04-14":1962,"2021-04-15":2090,"2021-04-22":3892},"2021-04-09":{"2021-04-12":1255,"2021-04-13":1527,"2021-04-14":1743,"2021-04-15":1903,"2021-04-16":2036,"2021-04-23":3812},"2021-04-10":{"2021-04-13":1181,"2021-04-14":1458,"2021-04-15":1680,"2021-04-16":1844,"2021-04-17":1982,"2021-04-24":3732},"2021-04-11":{"2021-04-14":1181,"2021-04-15":1458,"2021-04-16":1680,"2021-04-17":1844,"2021-04-18":1956,"2021-04-25":3706},"2021-04-12":{"2021-04-15":1181,"2021-04-16":1458,"2021-04-17":1680,"2021-04-18":1816,"2021-04-19":1930,"2021-04-26":3680},"2021-04-13":{"2021-04-16":1181,"2021-04-17":1458,"2021-04-18":1649,"2021-04-19":1788,"2021-04-20":1904,"2021-04-27":3654},"2021-04-14":{"2021-04-17":1181,"2021-04-18":1425,"2021-04-19":1618,"2021-04-20":1760,"2021-04-21":1878,"2021-04-28":3628},"2021-04-15":{"2021-04-18":1146,"2021-04-19":1392,"2021-04-20":1587,"2021-04-21":1732,"2021-04-22":1852,"2021-04-29":3602},"2021-04-16":{"2021-04-19":1111,"2021-04-20":1359,"2021-04-21":1556,"2021-04-22":1704,"2021-04-23":1826,"2021-04-30":3576},"2021-04-17":{"2021-04-20":1076,"2021-04-21":1326,"2021-04-22":1525,"2021-04-23":1676,"2021-04-24":1800},"2021-04-18":{"2021-04-21":1076,"2021-04-22":1326,"2021-04-23":1525,"2021-04-24":1676,"2021-04-25":1800},"2021-04-19":{"2021-04-22":1076,"2021-04-23":1326,"2021-04-24":1525,"2021-04-25":1676,"2021-04-26":1800},"2021-04-20":{"2021-04-23":1076,"2021-04-24":1326,"2021-04-25":1525,"2021-04-26":1676,"2021-04-27":1800},"2021-04-21":{"2021-04-24":1076,"2021-04-25":1326,"2021-04-26":1525,"2021-04-27":1676,"2021-04-28":1800},"2021-04-22":{"2021-04-25":1076,"2021-04-26":1326,"2021-04-27":1525,"2021-04-28":1676,"2021-04-29":1800},"2021-04-23":{"2021-04-26":1076,"2021-04-27":1326,"2021-04-28":1525,"2021-04-29":1676,"2021-04-30":1800},"2021-04-24":{"2021-04-27":1076,"2021-04-28":1326,"2021-04-29":1525,"2021-04-30":1676},"2021-04-25":{"2021-04-28":1076,"2021-04-29":1326,"2021-04-30":1525},"2021-04-26":{"2021-04-29":1076,"2021-04-30":1326},"2021-04-27":{"2021-04-30":1076},"2020-12-19":{"2020-12-26":1898},"2021-02-06":{"2021-02-13":2129},"2021-03-06":{"2021-03-13":2013,"2021-03-20":4292}}
      this.attributesDates = this.getAttributesDates()
      // this.postAPI({
      //   action: "getPricesAvailibility",
      //   idEstate: this.idEstate
      // }).then(response => {
      //   console.log(response)
      //   const apiResponse = response.data.data
      //   this.pricesAvailibility = apiResponse
      //   // this.disabledDates = this.getdisabledDates
      //   // this.$nextTick(() => {
      //   //   this.$refs.datepicker.parseDisabledDates()
      //   //   this.$refs.datepicker.reRender()
      //   // })
      //   this.attributesDates = this.getAttributesDates()
      // })
    },
  },
  created () {
    console.log("tret")
    this.getPricesAvailibility()
  }

}
</script>

<style>

</style>